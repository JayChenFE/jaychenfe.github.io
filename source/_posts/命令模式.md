---
title: 命令模式
date: 2019-05-22 22:53:03
categories: [设计模式]
tags:
top:
---

[TOC]

# 原理

![](https://raw.githubusercontent.com/JayChenFE/pic/master/20190526093521.png)

# 示例

## 计算器(C#)实现

设计一个计算器具有以下功能

- 可以进行整数的加减乘除
- 用户可以撤销操作
- 用户可以重新执行撤销的操作

代码如下:

Command类

```C#
    /// <summary>
    /// "Command"
    /// </summary>
    public abstract class Command
    {
        public abstract void Execute();
        public abstract void UnExecute();
    }
```

Calculator类(Receiver)

```C#
    /// <summary>
    /// "Receiver"
    /// </summary>
    public class Calculator
    {
        private int _curr = 0;
        public void Operation(char @operator, int operand)
        {
            switch (@operator)
            {
                case '+': _curr += operand; break;
                case '-': _curr -= operand; break;
                case '*': _curr *= operand; break;
                case '/': _curr /= operand; break;
            }
            Console.WriteLine($"Current value = {_curr} (afterOperating: {@operator} {operand})");
        }
    }
```

CalculatorCommand类(ConcreteCommand)

```C#
    /// <summary>
    /// "ConcreteCommand"
    /// </summary>
    public class CalculatorCommand : Command
    {
        private readonly Calculator _calculator;
        private readonly char _operator;
        private readonly int _operand;

        public CalculatorCommand(Calculator calculator, char @operator, int operand)
        {
            _operator = @operator;
            _operand = operand;
            _calculator = calculator;
        }

        public override void Execute()
        {
            _calculator.Operation(_operator, _operand);
        }
        public override void UnExecute()
        {
            _calculator.Operation(Undo(_operator), _operand);
        }

        private char Undo(char @operator)
        {
            char undo;
            switch (@operator)
            {
                case '+':
                    undo = '-';
                    break;
                case '-':
                    undo = '+';
                    break;
                case '*':
                    undo = '/';
                    break;
                case '/':
                    undo = '*';
                    break;
                default:
                    undo = ' ';
                    break;
            }
            return undo;
        }
    }
```

User类(Invoker)

```C#
    /// <summary>
    /// "Invoker"
    /// </summary>
    public class User
    {
        private readonly Calculator _calculator = new Calculator();
        private readonly List<Command> _commandList = new List<Command>();
        private int _current = 0;

        public void Redo(int levels)
        {
            Console.WriteLine("\n---- Redo {0} levels ", levels);

            for (int i = 0; i < levels; i++)
            {
                if (_current >= _commandList.Count - 1)
                {
                    break;
                }
                var command = _commandList[_current++];
                command.Execute();
            }
        }

        public void Undo(int levels)
        {
            Console.WriteLine("\n---- Undo {0} levels ", levels);
            // Perform undo operations
            for (int i = 0; i < levels; i++)
            {
                if (_current <= 0)
                {
                    break;
                }
                var command = _commandList[--_current];
                command.UnExecute();
            }
        }

        public void Compute(char @operator, int operand)
        {
            // Create command operation and execute it
            Command command = new CalculatorCommand(_calculator, @operator, operand);
            command.Execute();
            // Add command to undo list
            _commandList.Add(command);
            _current++;
        }
    }
```

客户端

```C#
   class Program
    {
        static void Main(string[] args)
        {
            // Create user and let her compute
            User user = new User();
            user.Compute('+', 100);
            user.Compute('-', 50);
            user.Compute('*', 10);
            user.Compute('/', 2);
            // Undo 4 commands
            user.Undo(4); 
            // Redo 3 commands
            user.Redo(3); 
            // Wait for user
            Console.Read();
        }
    }
```

